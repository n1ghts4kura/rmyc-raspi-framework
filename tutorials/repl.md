# UART 异步 REPL 串口调试工具使用说明

> *n1ghts4kura*: VSCode Copilot + **GPT5-Codex** 生成。**2025/9/30**

本工具位于 `src/repl.py`，基于 asyncio + prompt_toolkit 实现：

- 输出区实时显示“发送/接收”数据，附带日期时间戳（24h，毫秒）
- 颜色区分：更直观地区分发送/接收/告警
- 输入区固定在底部，回车即发；不阻塞接收显示
- 后台队列式接收线程，高频数据也流畅；自动贴近底部分隔线显示

注意：请根据你的设备修改 `src/bot/conn.py` 中的 `_device_address`（如 `/dev/ttyUSB0`、`/dev/ttyACM0`）。

## 启动

在项目根目录运行：

```bash
python3 -m src.repl
```

或（使用 venv 时）：

```bash
source venv/bin/activate
python -m src.repl
```

启动后界面（全屏）：

- 输出区 ≈ 80% 高度
- 中间 1 行分隔线
- 底部输入区 ≈ 20% 高度，提示符 `>>`

## 界面与颜色说明

- `[发送]` 行：亮绿（你发出的命令，按回车即刻显示）
- `[接收]` 行：湖蓝（下位机返回的数据）
- `[WARN]` 行：琥珀（发送失败等提示）
- `[YYYY-MM-DD HH:MM:SS.mmm]`：灰色时间戳（默认开启）

注：工具开启 TrueColor 渲染，若终端不支持，颜色可能降级显示。

## 常用操作

- 在底部输入，按 Enter 发送到串口
- 输出区自动滚动到最新，始终贴近分隔线显示

### 内置命令

> *n1ghts4kura*: 其实用不到这几个功能。你只需要知道**如何退出**就可以了。**2025/9/30**

- `:q` / `:quit` / `:exit` / `quit` / `exit`：退出
- `:help` / `:h` / `?`：显示帮助
- `:eol [crlf|lf|cr|none]`：设置/查看发送行结尾（默认 `crlf`）
  - 示例：
    - `:eol` → 显示当前设置
    - `:eol lf` → 发送时仅附加 `\n`
    - `:eol none` → 不附加行结尾（会原样发送输入内容）

### 快捷键

- `Ctrl+C`：退出 REPL

## 行为与设计说明（深入）

- 后台接收线程 + 队列：调用 `start_serial_worker()` 后由后台线程负责解析，避免阻塞事件循环
- 非阻塞解析：`read_serial_nonblock()` 以 CR/LF 为行结束；若空闲超过阈值会将缓存剩余当作一帧输出
- 输出历史：最多 10000 行，渲染时取最后最多 500 行，按当前窗口高度裁剪
- 底部贴线：按窗口高度在顶部补空行，内容始终贴近分隔线显示
- 重绘节流：≈16ms 刷新节流，输入更跟手

## 故障排查

1. 无法连接串口/无输出

- 确认 `src/bot/conn.py` 的 `_device_address`（`/dev/ttyUSB0`/`/dev/ttyACM0` 等）
- 权限：通常已在初始化中执行 `chmod`，若仍失败请手动 `sudo chmod 777 /dev/ttyUSB0`
- 波特率需与设备一致（默认 115200）

1. 发送失败提示

- 若出现 `[WARN] 发送失败，串口可能未连接或已断开。`，请检查连接与权限

1. 编辑器报“无法解析导入 prompt_toolkit...”，但终端可运行

- 让 VS Code 选择与你终端一致的 Python 解释器/虚拟环境；或在该环境安装依赖

1. 颜色不生效或显示异常

- 你的终端可能不支持 TrueColor；可更换终端或接受降级颜色

## 定制与拓展

- 可添加协议格式化（HEX/ASCII/JSON）、搜索、历史滚动/复制、命令补全等
- 如需持久化日志，可同步写入文件；或加入日志轮转
- 可暴露主题配置，允许自定义颜色映射
