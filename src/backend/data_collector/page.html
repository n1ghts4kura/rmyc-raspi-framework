<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>数据采集预览</title>
	<link rel="stylesheet" href="/collector/page.css" />
</head>
<body>
	<div class="wrapper">
		<header class="header">
			<div class="title">数据采集预览</div>
			<div class="subtitle">按 <span class="key">C</span> 或点击按钮保存当前帧</div>
		</header>

		<main class="layout" aria-label="数据采集布局">
			<section class="left" aria-label="视频流">
				<div class="stream-box">
					<img id="stream" src="/collector/stream" alt="MJPEG 实时流" />
				</div>
				<div id="status" class="status" data-type="info">等待流连接...</div>
				<div class="toast" aria-live="polite">
					<span class="toast-label">已保存</span>
					<span id="save-count" class="toast-count">0</span>
					<span class="toast-unit">张</span>
				</div>
			</section>

			<aside class="right" aria-label="操作区">
				<div class="top-controls">
					<button id="capture-btn" type="button" class="primary-btn">保存当前帧 (C)</button>
				</div>
				<div class="file-list" id="file-list" aria-live="polite"></div>
			</aside>
		</main>
	</div>

	<script>
		const statusEl = document.getElementById('status');
		const btn = document.getElementById('capture-btn');
		const img = document.getElementById('stream');
		const saveCountEl = document.getElementById('save-count');
		let savedCount = 0;
		const fileListEl = document.getElementById('file-list');
		let savedFiles = [];

		function renderFiles() {
			if (!fileListEl) return;
			if (!savedFiles.length) {
				fileListEl.innerHTML = '<div class="file-empty">暂无文件</div>';
				return;
			}
			fileListEl.innerHTML = savedFiles
				.map((name) => `<button class="file-chip" data-name="${name}">${name}</button>`)
				.join('');
		}

		async function initCount() {
			try {
				const res = await fetch('/collector/capture-count');
				const data = await res.json();
				if (res.ok) {
					savedCount = typeof data.count === 'number' ? data.count : 0;
					savedFiles = Array.isArray(data.files) ? data.files : [];
					saveCountEl.textContent = savedCount;
					renderFiles();
				}
			} catch (_) {
				// 忽略初始化失败，保持 0
			}
		}

		function setStatus(text, type = 'info') {
			statusEl.textContent = text;
			statusEl.dataset.type = type;
		}

		async function capture() {
			setStatus('正在保存当前帧...', 'info');
			btn.disabled = true;
			try {
				const res = await fetch('/collector/capture', { method: 'POST' });
				const data = await res.json();
				if (res.ok && data.ok) {
					const fname = (data.file || 'capture.jpg').split('/').pop();
					setStatus(`已保存: ${fname}`, 'success');
					savedCount += 1;
					saveCountEl.textContent = savedCount;
					if (fname) {
						savedFiles.unshift(fname);
						renderFiles();
					}
				} else {
					setStatus(`保存失败: ${data.error || '未知错误'}`, 'error');
				}
			} catch (err) {
				setStatus(`请求失败: ${err}`, 'error');
			} finally {
				btn.disabled = false;
			}
		}

		window.addEventListener('keydown', (e) => {
			if (e.key === 'c' || e.key === 'C') {
				e.preventDefault();
				capture();
			}
		});

		btn.addEventListener('click', capture);

		img.addEventListener('load', () => setStatus('流连接正常，可按 C 保存当前帧', 'success'));
		img.addEventListener('error', () => setStatus('流连接失败，请检查后端 /collector/stream', 'error'));

		fileListEl?.addEventListener('click', (e) => {
			const target = e.target;
			if (target instanceof HTMLElement && target.dataset.name) {
				window.open(`/collector/captures/${encodeURIComponent(target.dataset.name)}`, '_blank');
			}
		});

		initCount();
	</script>
</body>
</html>
