# 自瞄搜索策略实现记录

## 背景与目标
- **开发时间**：2025-10-04
- **相关版本**：v1.1
- **涉及模块**：
  - `src/config.py`（新增配置项）
  - `src/skill/autoaim.py`（实现搜索逻辑）

### 问题描述
在最初的自瞄系统实现中，当连续多帧（12帧）未检测到目标时，系统会执行云台回中操作。这种策略存在以下问题：

1. **响应太慢**：12 帧约 0.6 秒才触发（基于 20 Hz 控制频率）
2. **效率低下**：回中后重新开始瞄准，可能错过目标
3. **不够智能**：目标可能只是暂时被遮挡或移出视野边缘

### 设计目标
实现一个**自适应云台搜索策略**，当丢失目标时：
- ✅ 快速响应（5 帧即触发，约 0.25 秒）
- ✅ 持续搜索（持续旋转而非回中）
- ✅ 自适应性（根据推理速度动态调整搜索角度）
- ✅ 全范围覆盖（360° 连续搜索）

---

## 核心设计

### 设计思路
采用**持续固定方向旋转**策略，而非左右摆动或回中：

1. **连续旋转**：每帧旋转固定角度，持续同一方向
2. **动态角度**：根据推理 FPS 和相机 FOV 自动计算最优角度
3. **视野覆盖**：确保搜索过程不会漏掉目标

### 关键算法：自适应角度计算

#### 数学模型
```python
search_step_angle = min(
    CAMERA_FOV_HORIZONTAL × AIM_SEARCH_FOV_COVERAGE,  # 视野覆盖角度
    GIMBAL_SPEED / actual_fps                         # 推理间隔内能旋转的角度
)
```

#### 参数说明
- **`CAMERA_FOV_HORIZONTAL`**: 相机水平视野角度（70°）
- **`AIM_SEARCH_FOV_COVERAGE`**: 视野覆盖比例（0.7，即 70%）
- **`GIMBAL_SPEED`**: 云台旋转速度（90°/s）
- **`actual_fps`**: 实际推理频率（从 `recognizer.get_status()` 动态获取）

#### 计算示例
基于当前配置（推理 FPS ≈ 4.15）：
```python
选项1 = 70 × 0.7 = 49°         # 视野覆盖策略
选项2 = 90 / 4.15 = 21.7°      # 推理间隔限制

search_step_angle = min(49, 21.7) = 21.7°  # 取较小值
```

**含义**：每帧推理之间，云台旋转 21.7°，确保在下次推理时覆盖部分新区域，避免漏掉目标。

### 性能分析

#### 搜索速度
```
完整 360° 扫描 = 360° / 21.7° ≈ 16.6 帧
                = 16.6 / 20 Hz ≈ 0.83 秒
```

#### 视野覆盖率
- 每次旋转 21.7°，相机视野 70°
- 覆盖率 = 21.7 / 70 ≈ 31%
- **每帧推理能探测约 1/3 的新区域**

---

## 实现细节

### 配置参数（`src/config.py`）

新增配置项：
```python
# 自瞄控制参数
AIM_LOST_TARGET_TIMEOUT_FRAMES = 5   # 触发搜索的阈值（从 12 降至 5）
AIM_CONTROL_FREQUENCY = 20           # 自瞄控制频率（Hz）

# 自瞄搜索参数
AIM_SEARCH_FOV_COVERAGE = 0.7        # 搜索步进占视野角度的比例（0.6-0.8 推荐）
AIM_SEARCH_DIRECTION = 1             # 搜索方向（1=向右，-1=向左）
```

### 核心实现（`src/skill/autoaim.py`）

#### 启动时动态计算搜索角度
```python
# 获取实际推理 FPS
status = recognizer.get_status()
actual_fps = status.get('inference_fps', 4.0)

# 计算自适应搜索角度
search_step_angle = min(
    config.CAMERA_FOV_HORIZONTAL * config.AIM_SEARCH_FOV_COVERAGE,
    config.GIMBAL_SPEED / actual_fps
)

LOG.info(
    f"自瞄搜索参数: 推理FPS={actual_fps:.2f}, "
    f"搜索角度={search_step_angle:.1f}°, "
    f"视野覆盖={config.AIM_SEARCH_FOV_COVERAGE*100:.0f}%"
)
```

#### 搜索逻辑
```python
while skill.enabled:
    success = aim_step_v1(recognizer)
    
    if success:
        lost_frames = 0  # 检测到目标，重置计数器
    else:
        lost_frames += 1
        
        # 超过阈值时触发持续旋转搜索
        if lost_frames >= config.AIM_LOST_TARGET_TIMEOUT_FRAMES:
            yaw_angle = search_step_angle * config.AIM_SEARCH_DIRECTION
            rotate_gimbal(
                pitch=None,  # 不改变 pitch
                yaw=yaw_angle,
                vpitch=None,
                vyaw=config.GIMBAL_SPEED
            )
            LOG.debug(f"搜索模式：旋转 {yaw_angle:.1f}° (累计 {lost_frames} 帧无目标)")
    
    time.sleep(1.0 / config.AIM_CONTROL_FREQUENCY)
```

---

## 设计决策记录

### 为什么选择"持续旋转"而非"左右摆动"？

#### 备选方案对比

| 方案 | 优点 | 缺点 | 评分 |
|------|------|------|------|
| **A: 回中后重新开始** | 简单 | 效率低，可能错过目标 | ⭐⭐ |
| **B: 左右摆动扫描** | 覆盖更大范围 | 需要状态机，复杂度高 | ⭐⭐⭐ |
| **C: 持续旋转搜索** | 简单高效，连续覆盖 360° | 需要动态角度计算 | ⭐⭐⭐⭐⭐ |

#### 最终选择：方案 C（持续旋转）

**理由**：
1. ✅ **逻辑简单**：无需状态机，只需每帧旋转固定角度
2. ✅ **连续覆盖**：0.83 秒完成 360° 扫描，不会漏掉目标
3. ✅ **符合直觉**：类似人类搜索敌人时的转头动作
4. ✅ **易于调试**：参数化配置，可快速调整

### 为什么降低阈值（12 → 5 帧）？

**原阈值问题**：
- 12 帧 = 0.6 秒（基于 20 Hz 控制频率）
- 在快速移动场景下响应太慢

**新阈值优势**：
- 5 帧 = 0.25 秒
- 响应速度提升 **140%**
- 更快进入搜索模式，减少目标丢失时间

### 为什么使用动态角度计算？

**硬编码的问题**：
- 固定角度（如 30°）无法适应不同硬件性能
- 推理速度变化时（如降低分辨率），固定角度可能过大或过小

**动态计算的优势**：
- ✅ **自适应性**：根据实际推理 FPS 自动调整
- ✅ **硬件无关**：在不同树莓派/相机配置下都能优化
- ✅ **性能感知**：如果推理速度提升（如升级到树莓派 5），自动享受更大的搜索角度

---

## 遇到的问题与解决

### 问题 1：初次实现忘记同步文档

**现象**：
- 完成了重要的代码改进（自瞄搜索逻辑）
- 修改了 `config.py` 和 `autoaim.py`
- **但没有立即同步文档**

**影响**：
- AI 下次对话时缺少上下文
- 其他开发者（或未来的自己）无法理解设计思路

**解决方案**：
1. ✅ 在 `copilot-instructions.md` 中强化文档同步提醒
2. ✅ 添加**强制检查清单**（代码修改后必须执行）
3. ✅ 创建本 journey 文档记录设计过程

**经验教训**：
> ⚠️ **文档同步不是可选项，而是强制要求！**  
> AI 助手在完成代码修改后，必须主动检查文档同步需求。

---

## 性能/测试验证

### 理论性能指标

| 指标 | 数值 | 说明 |
|------|------|------|
| **搜索触发时间** | 0.25 秒 | 5 帧 × 0.05 秒/帧 |
| **360° 扫描时间** | 0.83 秒 | 16.6 帧 × 0.05 秒/帧 |
| **每帧覆盖范围** | 21.7° | 基于当前推理 FPS (4.15) |
| **视野利用率** | 31% | 21.7° / 70° |

### 待硬件测试验证的问题

1. **搜索速度是否合适**？
   - 0.83 秒完成 360° 是否太慢/太快？
   - 是否需要调整 `AIM_SEARCH_FOV_COVERAGE`（当前 0.7）？

2. **是否会漏掉快速移动的目标**？
   - 31% 的视野覆盖率是否足够？
   - 是否需要降低覆盖率（如 0.6）以提高搜索精度？

3. **持续旋转是否会导致控制不稳定**？
   - 云台高频旋转是否影响其他控制（如底盘移动）？

### 调试建议

```python
# 测试 1：验证搜索速度
# 启动自瞄后，手动遮挡目标，观察日志：
# "搜索模式：旋转 21.7° (累计 5 帧无目标)"

# 测试 2：调整覆盖率
# 如果经常漏目标，降低 AIM_SEARCH_FOV_COVERAGE 到 0.6
config.AIM_SEARCH_FOV_COVERAGE = 0.6

# 测试 3：改变搜索方向
# 测试向左搜索的效果
config.AIM_SEARCH_DIRECTION = -1
```

---

## 未来优化方向

### 短期优化

1. **自适应搜索方向**
   - 根据目标丢失前的位置，预测搜索方向
   - 例如：目标在左侧丢失 → 优先向左搜索

2. **渐进式搜索角度**
   - 刚丢失时小角度快速搜索（15°）
   - 持续丢失后扩大搜索范围（30°）

3. **记忆上次目标位置**
   - 在丢失位置附近优先搜索
   - 超过一定时间后才全范围扫描

### 中期优化

1. **多模式搜索策略**
   - **快速模式**：大角度（30°），快速覆盖
   - **精确模式**：小角度（10°），细致搜索
   - **混合模式**：先快速后精确

2. **结合 IMU 数据**（如果硬件支持）
   - 根据机器人自身旋转调整搜索策略
   - 避免重复搜索已覆盖区域

### 长期优化

1. **目标轨迹预测**
   - 使用卡尔曼滤波预测目标运动
   - 在预测位置优先搜索

2. **多目标切换策略**
   - 丢失当前目标时，快速切换到次优目标
   - 避免浪费时间搜索

---

## 参考资料

### 相关文档
- `documents/aimassistant_intro_for_ai.md` - 自瞄系统整体设计
- `documents/PERFORMANCE_OPTIMIZATION_SUMMARY.md` - 推理性能指标
- `.github/copilot-instructions.md` - 全局配置说明

### 相关代码
- `src/config.py` - 配置参数定义
- `src/skill/autoaim.py` - 自瞄技能实现
- `src/bot/gimbal.py` - 云台控制接口

---

**文档维护**：
- **创建日期**: 2025-10-04
- **最后更新**: 2025-10-04
- **状态**: ✅ 完成（待硬件测试验证）
