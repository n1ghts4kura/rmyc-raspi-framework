# 数据采集工具使用指南

## 📋 概述

`data_collector.py` 是整合了焦距调整和数据采集功能的工具，用于YOLO模型训练数据采集。

### ✨ 核心功能

| 功能 | 按键 | 说明 |
|------|------|------|
| 📷 **拍照** | `C` / `S` | 保存当前帧（应用Gamma校正） |
| 🎬 **录像** | `R` | 开始/停止录制（MJPG编码） |
| 📐 **焦距调整** | - | 十字准线辅助对焦 |
| ℹ️ **图像信息** | `I` | 显示亮度、分辨率等信息 |
| ❌ **退出** | `Q` | 退出程序 |

## 🚀 快速开始

### 基本使用
```bash
cd /home/pi/Desktop/framework_v1_1/rmyc-raspi-framework
python3 training/data_collector.py
```

### 使用虚拟环境
```bash
cd /home/pi/Desktop/framework_v1_1/rmyc-raspi-framework
source venv/bin/activate
python training/data_collector.py
```

## 📝 使用流程

### 1. 启动程序
```bash
python3 training/data_collector.py
```

程序会自动：
- 打开摄像头（默认索引0）
- 设置分辨率为 1280x720
- 创建保存目录 `training/captured/`

### 2. 调整焦距
- 观察画面中心的**绿色十字准线**区域
- 手动旋转摄像头镜头调焦环
- 关注细节清晰度（文字、边缘）

### 3. 采集数据

#### 拍照采集
- 找到合适的目标或场景
- 按 `C` 或 `S` 键拍照
- 文件保存为 `photo_YYYYMMDD_HHMMSS.jpg`
- 自动应用 **Gamma 1.3 校正**

#### 录像采集
- 按 `R` 键开始录制（画面右上角显示红色 "🔴 REC"）
- 移动机器人或改变场景
- 再次按 `R` 键停止录制
- 文件保存为 `video_YYYYMMDD_HHMMSS.avi`（MJPG编码）

### 4. 查看信息
- 按 `I` 键查看当前图像信息：
  - 图像形状
  - 数据类型
  - 平均亮度
  - 亮度范围
  - Gamma校正值

### 5. 退出程序
- 按 `Q` 键安全退出
- 程序会自动：
  - 停止录制（如果正在录制）
  - 释放摄像头资源
  - 显示运行统计

## ⚙️ 配置参数

可以在 `data_collector.py` 的 `main()` 函数中自定义参数：

```python
collector = DataCollector(
    camera_index=0,           # 摄像头索引（根据实际设备修改）
    width=1280,               # 分辨率宽度
    height=720,               # 分辨率高度
    fps=30,                   # 目标帧率
    save_dir="training/captured",  # 保存目录
    gamma=1.3                 # Gamma校正值（>1提亮，<1压暗）
)
```

## 📂 输出文件

所有文件保存在 `training/captured/` 目录：

```
training/captured/
├── photo_20251012_173000.jpg   # 拍摄的照片（Gamma校正后）
├── photo_20251012_173015.jpg
├── video_20251012_173100.avi   # 录制的视频（MJPG编码）
└── video_20251012_173200.avi
```

### 文件命名规则
- **照片**: `photo_YYYYMMDD_HHMMSS.jpg`
- **视频**: `video_YYYYMMDD_HHMMSS.avi`

### 视频编码说明
- **编码格式**: MJPG (Motion JPEG)
- **文件格式**: AVI
- **优势**: 树莓派广泛支持，无需额外编解码器
- **用途**: 保留原始数据质量，适合后续标注和训练

## 🛠️ 故障排除

### 问题1: 摄像头无法打开
```bash
# 查看可用摄像头
ls /dev/video*

# 查看设备详情
v4l2-ctl --list-devices

# 修改摄像头索引
# 在代码中将 camera_index=0 改为实际索引
```

### 问题2: 录像无法播放
- 确认使用支持 MJPG/AVI 的播放器（VLC、MPV）
- 检查文件大小，确认录制成功

### 问题3: 画面过曝/过暗
- 调整 Gamma 值：
  - `gamma=1.5` 或更高：提亮画面
  - `gamma=0.8` 或更低：压暗画面
  - 默认 `gamma=1.3`

### 问题4: 帧率过低
- 降低分辨率（如 `width=640, height=480`）
- 检查系统负载
- 确保充足光照（降低相机自动曝光时间）

## 💡 数据采集技巧

### 拍照采集建议
- **多角度**: 从不同角度拍摄目标
- **多距离**: 近景、中景、远景都要采集
- **多光照**: 亮光、暗光、逆光等场景
- **多姿态**: 目标的不同朝向和状态

### 录像采集建议
- **动态场景**: 录制机器人移动过程
- **连续动作**: 录制完整的技能执行过程
- **时长控制**: 每段视频 10-30 秒为宜
- **后期处理**: 可用工具提取关键帧标注

### 焦距调整建议
- **看细节**: 关注文字、边缘、纹理等细节区域
- **多测试**: 对准不同距离的物体测试
- **保存参考**: 拍摄多张不同焦距的图像对比
- **固定焦距**: 找到最佳焦距后固定镜头

## 📊 质量检查

采集后检查数据质量：

```bash
# 查看照片数量
ls training/captured/photo_*.jpg | wc -l

# 查看视频数量
ls training/captured/video_*.avi | wc -l

# 查看文件大小
du -sh training/captured/
```

### 质量标准
- **照片**: 清晰、无模糊、目标完整
- **视频**: 流畅、无丢帧、场景连续
- **数量**: 
  - 每类目标至少 100 张照片
  - 每种场景至少 5 段视频

## 🔗 相关工具

- **原始工具（已删除，功能已整合）**:
  - `camera_focus_test.py` - 纯焦距调整工具（已整合）
  - `training/capture.py` - 原始数据采集工具（已整合）
  
- **整合优势**:
  - ✅ 统一界面，减少工具切换
  - ✅ 高清预览 (1280x720)
  - ✅ 修复录像编码问题 (MJPG)
  - ✅ 保留所有核心功能

## 📚 技术细节

### Gamma校正原理
```python
# Gamma > 1: 提亮暗部，适合过曝场景
# Gamma < 1: 压暗高光，适合欠曝场景
# Gamma = 1: 无变化
inv_gamma = 1.0 / gamma
output = ((input / 255.0) ** inv_gamma) * 255
```

### MJPG编码说明
- **全称**: Motion JPEG
- **原理**: 每帧独立JPEG压缩
- **优点**: 兼容性好、编辑友好、支持广泛
- **缺点**: 文件较大（相比H.264）
- **适用**: 数据采集、后期处理

---

## 📝 更新日志

### v1.0 (2025-10-12)
- ✨ 整合焦距调整和数据采集功能
- 🔧 修复录像编码问题（mp4v → MJPG）
- 🎨 优化UI显示（全尺寸预览 + 十字准线）
- 📚 完善类型提示和文档注释
- 🚀 支持摄像头索引重试

---

**作者**: RMYC Framework Team  
**维护**: 2025-10-12  
**许可**: 项目内部工具
